# v4 Milestone: Runtime Expansion

Status: `completed` (runtime layer)

## Goal

Expand Cy runtime expressiveness and tooling beyond the v3 bootstrap baseline.

## Implemented

1. Control-flow expansion
- `while (...) { ... }`
- `for (item in iterable) { ... }` for arrays and objects (object iteration yields keys)
- `break;` and `continue;`

2. Syntax expansion
- Array comprehensions: `[expr for x in iterable if cond]`
- Assignment targets beyond identifiers:
  - member assignment: `obj.key = value;`
  - index assignment: `arr[i] = value;`, `obj["k"] = value;`
- `class Name { ... }` declaration syntax
- `module Name { ... }` declaration syntax
- `typealias Name = expr;` declaration syntax

3. Object/class runtime model
- Object kinds: plain/module/class/instance
- Module-safe member access (no implicit receiver binding on module calls)
- Instance method dispatch through `__class__` fallback
- `new(class_obj, ...)` builtin with `init(self, ...)` constructor convention

4. VM/performance hardening
- `--vm` keeps bytecode execution for expressions
- Added expression bytecode cache to avoid recompiling hot expressions
- VM fallback to AST path for currently unsupported expression forms (e.g. comprehensions)

5. Tooling depth
- Added linter wrappers:
  - `scripts/cylint.sh`
  - `scripts/cylint.ps1`
- Runtime parser/lint mode:
  - `cy --parse-only file.cy`
  - `cy --lint file.cy`
- Added acceptance test:
  - `scripts/test_v4.sh`

6. Compatibility hooks
- `lang_version()` builtin
- `require_version("...")` builtin for explicit runtime compatibility checks
- `--max-alloc N` allocation guard for runaway-script protection

## Validation

All existing and new scripts pass:

```bash
./scripts/test_v0.sh
./scripts/test_v1.sh
./scripts/test_v2.sh
./scripts/test_v3_start.sh
./scripts/test_ecosystem.sh
./scripts/test_v4.sh
```

## Note

Direct C codegen (`compiler/v3_compiler_template.c`) now covers most v4 statement-level syntax:
- `while` / `for` / `break` / `continue`
- `class` / `module` / `typealias`
- member/index assignment
- compatibility builtins (`keys`, `new`, `lang_version`, `require_version`)

Current remaining gap: statement-level VM has AST fallback for not-yet-bytecoded statement internals; `--vm-strict` now enforces no expression fallback.
